<!DOCTYPE html>
<html>
<head>
	<style>
		div {
			display: flex;
			flex-direction: column;
			align-items: center;
			align-content: center;
			justify-content: center;
		}
		
		div.wrapper {
			border: 2px solid black;
			height: 700px;
			width: 700px;
			margin: auto;
			display: flex;
			align-items: center;
			align-content: center;
			justify-content: center;
			font-family: verdana;
		}

		div.start-page {
			display: flex;
			/*flex-direction: row;*/
			width: 400px;
			justify-content: space-around;
		}
		
		div.start-page button {
			height: 100px;
			width: 100px;
		}
		
		div.img {
			height: 500px;
			width: 500px;
		}
		
		div.start {
			font-size: 15px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			padding: 70px;
		}
		
		img {
			max-width:100%;
			max-height:100%;
		}
		
		button {
			height: 30px;
			width: 70px;
		}
		
		span#word {
			font-size: 50px;
		}

		span#instruction1 {
			font-size: 30px;
		}

		div.buttonDiv{
			display: flex;
			flex-direction: row;
			justify-content: space-around;
			padding: 70px;
			width: 400px;
		}
		
		button.remove-button {
			width: 20px;
			height: 20px;
			margin-left: 20px;
		}
		
	</style>
	
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="FileSaver.js/FileSaver.js" type="text/javascript"></script>
<script>
	var zeros = [];
	var nonzeros = [];
	var TRIAL_ONE_NUM;
	var TRIAL_TWO_NUM;
	var subjectID;
	var subjectCondition;
	var responseOne = [];
	var responseTwo = [];
	var numSec = 1000;
	var AFTER_STIMULI_BREAK = 1; //originally used 30
	var BETWEEN_TRIALS_SEC = 8; //originally used 120
	var BETWEEN_WORDS_SEC = 0.01; //originally used 1
	
	$(document).ready(function(){
		var objects = ['lightbulb', 'apple', 'battery', 'laptop', 'handcuff', 'violin', 'scissors', 'chair', 'spaghetti', 'chicken', 'shoes', 'sunglasses', 'basketball', 'dice', 'clock', 'backpack', 'pearl', 'camera', 'piano', 'soap', 'pencil', 'soccerball', 'watch', 'mailbox', 'toothbrush', 'notebook', 'umbrella', 'starbucks', 'flowers', 'bread', 'box', 'rubberduck', 'stapler', 'car', 'cap', 'tree', 'cat', 'bottle', 'cake', 'scooter'];
		
		initExperiment(objects); // array of files: 20 zero, 5 one, 5 two, 5 three, 5 four
		renderStartPage();
	});
	
	function initExperiment(objects) {
		var numVersion = [20,5,5,5,5]
		var versions = []
		for (var i=0; i<5; i++) {
			for (var j=0; j<numVersion[i]; j++) {
				versions.push(i)
			}	
		} 
		shuffleArray(versions);

		console.assert(objects.length, "len(objects) != len(versions)", objects, versions)		
		for (var i=0; i<versions.length; i++) {
			word = objects[i]
			ver = versions[i]
			if (versions[i] == 0) {
				zeros.push([word, ver])
			} else {
				nonzeros.push([word, ver])
			}
		}
	}
		
	function initTimer(totalSec, callBack) {
		var sec = totalSec;
		var timer = $("<div></div>").addClass("timer");
		timer.html("seconds left: " + String(sec) + " seconds")
		var id = setInterval(function() {
			sec -= 1; 
			$('.timer').html("seconds left: " + String(sec) + " seconds")	

			if (sec == 0) {
				clearInterval(id)
				callBack()
			}
		}, 1 * numSec)
		return timer
	}
	
	function clearPage() {
		$('div.wrapper').html(""); // clear page
	}
	
	function startTrial(trialNum) {
		clearPage()
		var divStimulus = $('<div></div>').addClass("stimulus");
		$('div.wrapper').append(divStimulus);
		if (trialNum != 1) {
			divImg = $('<div></div>').addClass('img')
			divStimulus.append(divImg)
		}
		var span = $("<span></span>").attr("id", "word")
		divStimulus.append(span)
		
		var idx = 0;
		
		function nextWord() {			
			var L;
			if (trialNum==1) { //do not change this.
				L = zeros
			} else {
				L = nonzeros
			}
			
			if (idx < L.length) {
				var pair = L[idx]
				var word = pair[0]
				var version = pair[1]
				var img_path = "images/" + word + '-' + String(version) + '.png'

				if (trialNum != 1) {
					img = $("<img></img>").attr("src", img_path)
					$('div.img').html(img)
				}
				
				$('#word').html(word);
				idx++;
			} else {
				$('.stimulus').html('<h3>Completed.</h3> Please take 30 seconds break.')
				$('.stimulus').append(initTimer(AFTER_STIMULI_BREAK, function() {renderTestPage(trialNum)}))
				idx = 0;
				clearInterval(intvlId);
			}
		}
		
		$("div.start").remove();
		intvlId = setInterval(nextWord, BETWEEN_WORDS_SEC * numSec);
	}
	
	function renderStartPage() {
		var wrapper = $("div.wrapper")
		var div = $("<div></div>").addClass("start-page")

		var span = $('<span></span>').addClass("instruction1")
		span.html("In the textbox below, please enter four numerical digits for your month and date of birth (i.e. 0123 for January 23). This will help us differentiate your data while preserving anonymity.")
		div.append(span);

		var inputID = $('<input type="text" class="id">')
		inputID.focus()
		div.append(inputID)

		var div1 = $("<div></div>").addClass("buttonDiv")
		var button1 = $("<button>Start Normal Condition</button>").click(function() {
			TRIAL_ONE_NUM = 1
			TRIAL_TWO_NUM = 2
			renderInstruction(TRIAL_ONE_NUM) 
			subjectID = inputID.val()
			console.log(subjectID)
			subjectCondition = "_N"
		})
		var button2 = $("<button>Start Reverse Condition</button>").click(function() {
			TRIAL_ONE_NUM = 2
			TRIAL_TWO_NUM = 1
			renderInstruction(TRIAL_ONE_NUM) 
			subjectID = inputID.val()
			console.log(subjectID)
			subjectCondition = "_R"
		})
		div1.append(button1)
		div1.append(button2)
		div.append(div1)
		wrapper.append(div)
	}
	
	function renderInstruction(trialNum) {
		clearPage()
		var divStart = $('<div></div>').addClass('start')
		$('div.wrapper').prepend(divStart);

		var span = $('<span></span>').addClass("instruction")
		span.html("Memorize as many words as you can. You will have 1 second for each word.")
		divStart.append(span);

		var button = $("<button>Start Trial 1</button>").html("Start Trial #" + String(trialNum))
		button.click(function() {startTrial(trialNum)}) // trial 1 button

		divStart.append(button)
	}
	
	function renderTestPage(trialNum) {	
		clearPage()
		var response;
		if (trialNum == 1) {
			data = responseOne;
		} else {
			data = responseTwo;
		}
		
		var wrapper = $("div.wrapper")
		var responses = $("<div></div>").addClass("responses")
		var h3 = $("<h3>Words Recalled</h3>")
		var input = $('<input type="text" class="response" onkeypress="submitResponse(data)">')
		input.focus()

		var button= $('<button class="submit" onclick="submitResponse(data)">Submit</button>')
		wrapper.append(responses);
		responses.append(h3)
		responses.append(initTimer(BETWEEN_TRIALS_SEC, function() {
			if (trialNum == TRIAL_ONE_NUM) {
				renderInstruction(TRIAL_TWO_NUM)
			} else {
				renderFinishedScreen();
			}
		}))
		responses.append("<ul></ul>")
		wrapper.append(input)
		wrapper.append(button)		
	}
	
	function renderFinishedScreen() {
		console.log("renderFinishedScreen")
		clearPage()
		$("div.wrapper").html("Completed.");
		printInfo();
	}
		
	function printInfo() {
		if (TRIAL_ONE_NUM == 1) {
			console.log("trial 1 without word")
			console.log("zeros=" + String(zeros))
			console.log("responseOne=" + String(responseOne))
			
			console.log("trial 2 with word")
			console.log("nonzeros=" + String(nonzeros))
			console.log("responseTwo=" + String(responseTwo))
		}	else {
			console.log("trial 1 with word")
			console.log("nonzeros=" + String(nonzeros))
			console.log("responseTwo=" + String(responseTwo))
			
			console.log("trial 2 without word")
			console.log("zeros=" + String(zeros))
			console.log("responseOne=" + String(responseOne))
		}
		saveInfo()
	}

	function saveInfo(){
		var zero = String(zeros)
		var response_one = String(responseOne)
		var nonzero = String(nonzeros)
		var response_two = String(responseTwo)
		// any kind of extension (.txt,.cpp,.cs,.bat)
		var filename = subjectID+subjectCondition+".txt";
		if (TRIAL_ONE_NUM==1){
			var t1 = "trial 1 without word"
			var newline = "\n"
			var t2 = "trial 2 with word"
			var blob = new Blob([t1, newline, zero, newline, response_one, newline, t2, newline, nonzero, newline, response_two], {
			 type: "text/plain;charset=utf-8"
			});
		}else{
			var t1 = "trial 1 with word"
			var t2 = "trial 2 without word"
			var blob = new Blob([t1, nonzero, response_two, t2, zero, response_one], {
			 type: "text/plain;charset=utf-8"
			});
		}
		saveAs(blob, filename);
	}


	function submitResponse(data) {
		var response = $("input.response").val()
		if(response.length > 0 && response!=" "){
			if (data.indexOf(response) >= 0) {
				alert(response + " is already in the list.")
				$("input.response").focus()
			}else{
				data.push(response)
				var li = $("<li></li>").html(response).addClass(response)
				$('div.responses').find('ul').append(li)
				$("input.response").val("")

				//append a button that removes the word
				var button = $("<button>x</button>").addClass("remove-button")
				button.click(function() {
					response = this.parentElement.className
					$("li."+response).remove();
					data.splice(data.indexOf(response), 1)
				})
				li.append(button)
				$("input.response").focus()
			}
		}
	}
	
	/**
	 * Randomize array element order in-place.
	 * Using Durstenfeld shuffle algorithm.
	 */
	function shuffleArray(array) {
			for (var i = array.length - 1; i > 0; i--) {
					var j = Math.floor(Math.random() * (i + 1));
					var temp = array[i];
					array[i] = array[j];
					array[j] = temp;
			}
	}
</script>
</head>
<body>
	<div class="wrapper">
		<!--	insert corresponding content	-->
	</div>
</body>
</html>
